name: Lint GitHub Actions

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - '**/*.yml'
      - '**/*.yaml'
  push:
    paths:
      - '.github/workflows/**'
      - '**/*.yml'
      - '**/*.yaml'
    branches:
      - main
      - develop

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint GitHub Actions
        uses: github/super-linter@v5
        env:
          VALIDATE_YAML: "true"
          VALIDATE_GITHUB_ACTIONS: "true"
          VALIDATE_MARKDOWN: "true"
          VALIDATE_SHELL_SHFMT: "true"
          VALIDATE_EDITORCONFIG: "true"
          DEFAULT_BRANCH: "main"
          DISABLE_ERRORS: "false"

      - name: Custom environment variable check
        run: |
          # ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
          if [ -f "scripts/check-github-actions.sh" ]; then
            ./scripts/check-github-actions.sh
          else
            echo "âš ï¸  ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åŸºæœ¬çš„ãªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"

            echo "ğŸ” ç’°å¢ƒå¤‰æ•°ã®ç›´æ¥å‚ç…§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
            VIOLATIONS=0

            for file in .github/workflows/*.yml .github/workflows/*.yaml; do
              if [ -f "$file" ]; then
                echo "ğŸ“„ ãƒã‚§ãƒƒã‚¯ä¸­: $file"

                if grep -q "env\." "$file"; then
                  echo "âŒ ç’°å¢ƒå¤‰æ•°ã®ç›´æ¥å‚ç…§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: $file"
                  VIOLATIONS=$((VIOLATIONS + 1))
                fi
              fi
            done

            if [ $VIOLATIONS -gt 0 ]; then
              echo "ğŸš¨ åˆè¨ˆ $VIOLATIONS ä»¶ã®é•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
              exit 1
            fi
          fi

      - name: Check workflow syntax
        run: |
          echo "ğŸ” ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ§‹æ–‡ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "ğŸ“„ æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ä¸­: $file"

              # GitHub Actionsã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
              if ! yamllint "$file"; then
                echo "âŒ æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: $file"
                exit 1
              fi

              echo "âœ… æ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†: $file"
            fi
          done

      - name: Security check
        run: |
          echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ä¸­..."

          # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æ¤œå‡º
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "ğŸ“„ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ä¸­: $file"

              # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡º
              if grep -i -E "(password|token|secret|key).*:.*['\"][^'\"]{8,}['\"]" "$file"; then
                echo "âŒ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: $file"
                echo "   ä»£ã‚ã‚Šã«ã€GitHub Secretsã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
                exit 1
              fi

              echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†: $file"
            fi
          done
