name: Lint GitHub Actions

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - '**/*.yml'
      - '**/*.yaml'
  push:
    paths:
      - '.github/workflows/**'
      - '**/*.yml'
      - '**/*.yaml'
    branches:
      - main
      - develop

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint GitHub Actions
        uses: github/super-linter@v5
        env:
          VALIDATE_YAML: "true"
          VALIDATE_GITHUB_ACTIONS: "true"
          VALIDATE_MARKDOWN: "true"
          VALIDATE_SHELL_SHFMT: "true"
          VALIDATE_EDITORCONFIG: "true"
          DEFAULT_BRANCH: "main"
          DISABLE_ERRORS: "false"

      - name: Custom environment variable check
        run: |
          # カスタムスクリプトを使用して環境変数チェック
          if [ -f "scripts/check-github-actions.sh" ]; then
            ./scripts/check-github-actions.sh
          else
            echo "⚠️  カスタムスクリプトが見つかりません。基本的なチェックを実行します。"

            echo "🔍 環境変数の直接参照をチェック中..."
            VIOLATIONS=0

            for file in .github/workflows/*.yml .github/workflows/*.yaml; do
              if [ -f "$file" ]; then
                echo "📄 チェック中: $file"

                if grep -q "env\." "$file"; then
                  echo "❌ 環境変数の直接参照が検出されました: $file"
                  VIOLATIONS=$((VIOLATIONS + 1))
                fi
              fi
            done

            if [ $VIOLATIONS -gt 0 ]; then
              echo "🚨 合計 $VIOLATIONS 件の違反が検出されました"
              exit 1
            fi
          fi

      - name: Check workflow syntax
        run: |
          echo "🔍 ワークフローの構文をチェック中..."

          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "📄 構文チェック中: $file"

              # GitHub Actionsの構文チェック
              if ! yamllint "$file"; then
                echo "❌ 構文エラーが検出されました: $file"
                exit 1
              fi

              echo "✅ 構文チェック完了: $file"
            fi
          done

      - name: Security check
        run: |
          echo "🔒 セキュリティチェック中..."

          # ハードコードされたシークレットの検出
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "📄 セキュリティチェック中: $file"

              # パスワードやトークンのハードコードを検出
              if grep -i -E "(password|token|secret|key).*:.*['\"][^'\"]{8,}['\"]" "$file"; then
                echo "❌ ハードコードされたシークレットが検出されました: $file"
                echo "   代わりに、GitHub Secretsを使用してください"
                exit 1
              fi

              echo "✅ セキュリティチェック完了: $file"
            fi
          done
